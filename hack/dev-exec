#!/usr/bin/env bash
# dev-exec - Execute commands in the persistent dev environment
#
# Usage:
#   ./hack/dev-exec go test ./pkg/...
#   ./hack/dev-exec m app list
#   ./hack/dev-exec bash  # Get a shell
#   ./hack/dev-exec --root bash hack/dev-server start  # Run as root
#
# This script executes commands in the persistent dev container created by
# `make dev`. The session name is automatically derived from the current
# directory, ensuring each worktree has its own isolated dev environment.

set -e

# Parse --root flag
RUN_AS_ROOT=false
if [[ "$1" == "--root" ]]; then
  RUN_AS_ROOT=true
  shift
fi

# Check if .iso directory exists (indicates we're in the repo root)
if [ ! -d ".iso" ]; then
  echo "Error: This script must be run from the repository root" >&2
  echo "" >&2
  echo "Current directory: $(pwd)" >&2
  echo "" >&2
  echo "Please cd to the repository root directory first." >&2
  exit 1
fi

# Generate session name based on current directory
SESSION="dev-$(basename "$(pwd)")"

# Check if the dev environment is running by checking iso status output
STATUS_OUTPUT=$(ISO_SESSION="$SESSION" iso status --session "$SESSION" 2>&1)

if echo "$STATUS_OUTPUT" | grep -q "Container does not exist"; then
  echo "Error: Dev environment session '$SESSION' is not running" >&2
  echo "" >&2
  echo "Please start the dev environment first with:" >&2
  echo "  make dev" >&2
  echo "  or" >&2
  echo "  make dev-tmux" >&2
  exit 1
fi

# Execute command in the persistent dev container

# Guard: if no arguments or just 'bash', drop into an interactive shell
if [ "$#" -eq 0 ] || [[ "$#" -eq 1 && "$1" == "bash" ]]; then
  if [ "$RUN_AS_ROOT" = true ]; then
    ISO_SESSION="$SESSION" iso run -- bash -c "cd /src && exec bash"
  else
    ISO_SESSION="$SESSION" iso run -- bash -c "cd /src && exec su dev"
  fi
  exit
fi

# Run as root if --root flag was provided
if [ "$RUN_AS_ROOT" = true ]; then
  ISO_SESSION="$SESSION" iso run -- bash -c "cd /src && $*"
else
  # Build a properly quoted command string to preserve arguments with spaces/special chars
  # Use -s /bin/bash to ensure ANSI-C quoting ($'...' from printf %q) is supported
  CMD="cd /src && "
  for arg in "$@"; do
    CMD+="$(printf '%q ' "$arg")"
  done
  ISO_SESSION="$SESSION" iso run -- su -s /bin/bash dev -c "$CMD"
fi
