name: runtime
services:
  runtime:
    image: mirendev/runtime:latest
    ports:
      - 443:443
      - 80:80
      - 8443:8443/udp
    privileged: true
    labels:
      computer.runtime.cluster: "local"
    volumes:
      - containerd:/var/lib/containerd
      - runtime:/var/lib/runtime
    restart: always
    depends_on:
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    environment:
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_PASSWORD=default
    volumes:
      - clickhouse:/var/lib/clickhouse
    restart: always
    healthcheck:
      # Can just use 'db' as the host since we're inside the container network
      test: ["CMD", "clickhouse-client", "--host", "clickhouse", "--query", "SELECT 1"]
      interval: 1s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:17
    environment:
      - POSTGRES_DB=runtime_prod
      - POSTGRES_PASSWORD=runtime
      - POSTGRES_USER=runtime
    volumes:
      - postgres:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=runtime pg_isready -U runtime -d runtime_prod"]
      interval: 1s
      timeout: 5s
      retries: 5

volumes:
  clickhouse:
    # ok
  postgres:
    # ok
  containerd:
    # ok
  runtime:
    # ok
