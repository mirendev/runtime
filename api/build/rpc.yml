apiVersion: miren.dev/rpc/v1
kind: IDL

imports:
  stream:
    path: ../../pkg/rpc/stream/stream.yml
    import: miren.dev/runtime/pkg/rpc/stream

types:
  - type: Status
    fields:
      - name: kind
        type: string
        index: 0
      - name: update
        type: union
        union:
          - name: message
            type: string
            index: 1
          - name: buildkit
            type: bytes
            index: 2
          - name: error
            type: string
            index: 3

  - type: AccessInfo
    doc: Information about how to access the deployed application
    fields:
      - name: hostnames
        type: '[]string'
        index: 0
        doc: Hostnames where the app is accessible (from configured routes)
      - name: default_route
        type: bool
        index: 1
        doc: Whether this app is the default route
      - name: cluster_hostname
        type: string
        index: 2
        doc: Cloud-provisioned DNS hostname for the cluster (if registered with Miren Cloud)

interfaces:
  - name: Stream
    methods:
      - name: recv
        parameters:
          - name: count
            type: int32
        results:
          - name: data
            type: bytes

  - name: Builder
    methods:
      - name: buildFromTar
        parameters:
          - name: application
            type: string
          - name: tardata
            type: stream.RecvStream[[]byte]
          - name: status
            type: stream.SendStream[*Status]
        results:
          - name: version
            type: string
          - name: access_info
            type: '*AccessInfo'
            doc: Information about how to access the deployed app

