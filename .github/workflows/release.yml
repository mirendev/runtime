name: Dagger

on:
  push:
    branches: [ "main", "evan/mir-146" ]

jobs:
  package:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
    - uses: actions/checkout@v4
    - name: Build and package for ${{ matrix.arch }}
      uses: dagger/dagger-for-github@v7
      with:
        verb: call
        args: package --dir=. export --path=release-linux-${{ matrix.arch }}.tar.gz
        cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: runtime-linux-${{ matrix.arch }}
        path: release-linux-${{ matrix.arch }}.tar.gz
        retention-days: 7

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Get or create tip release
        id: get_or_create_release
        run: |
          # Try to get existing release ID
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/tip -q .id 2>/dev/null || echo "")
          
          # If no release exists, create one
          if [ -z "$RELEASE_ID" ]; then
            echo "Creating new tip release..."
            RELEASE_ID=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              repos/${{ github.repository }}/releases \
              -f tag_name='tip' \
              -f name='Tip Build' \
              -f body='Latest build from main branch' \
              -f prerelease=true \
              -q .id)
          else
            echo "Using existing tip release with ID: $RELEASE_ID"
          fi
          
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload release assets
        run: |
          function upload_asset() {
            local arch=$1
            local asset_name="runtime-linux-$arch.tar.gz"
            local artifact_path="artifacts/runtime-linux-$arch/release-linux-$arch.tar.gz"
            
            echo "Processing $asset_name..."
            
            # Check if asset already exists
            ASSET_ID=$(gh api repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}/assets -q '.[] | select(.name=="'$asset_name'") | .id' 2>/dev/null || echo "")
            
            # If asset exists, delete it first
            if [ -n "$ASSET_ID" ]; then
              echo "Deleting existing asset $asset_name with ID: $ASSET_ID"
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
            fi
            
            # Upload the new asset
            echo "Uploading $asset_name..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/octet-stream" \
              "repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}/assets?name=$asset_name" \
              --input "$artifact_path"
          }
          
          # Upload both assets
          upload_asset "amd64"
          upload_asset "arm64"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
